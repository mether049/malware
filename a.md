表作成
1次調査（キーの発見）
- 統計情報から異常値の発見
	- 特定フィールドで送信もしくは受信パケット数・byteが大きい
		- tshark
			- ポートサマリ
				-  tshark -n -C no_desegment_tcp -r hoge.pcap  -q -z io,phs
		- sof-elk
		- molochs
		- tcpflow
			- tcpflow -e netviz -r hogehoge.pcap
               		- display hogehoge.pdf
		- tcpstat
		- netflow
			- IPアドレス，ポート，プロトコルサマリ
				- nfdump -R ../2018 -N
			- 送信元が外部のサマリ
				- nfdump -R ../2018/ -s srcip/bytes -n 5 'not src net 172.16.0.0/16'
			- 送信元が内部のサマリ
				- nfdump -R ../2018/ -s srcip/bytes -n 5 'src net 172.16.0.0/16'
	- 営業時間外の予期しない通信
		- sof-elk
			- 時間のグラフからスパイクを見つける
		- moloch
			- 時間のグラフからスパイクを見つける
	- 内部ネットワークのマシン同士の直接アクセス
		- sof-elk
			- srcとdetがともに内部ネットワークのものを検索
				- src_ip:[172.16.0.0 TO 172.16.255.255]
		- nfdump
			nfdump -R ./victim-gw/var/log/netflow/localhost/2013/08/ -n 20   'src net xx/ and dst net xx/'

		- moloch
	- 内部プロキシやDNSを経由しないアクセス
		- sof-elk
			- dns通信とnot 内部DNSサーバで検索
				- ipd:172.16.8.8 AND
		- Wireshark
			- dns.a == hogeip
		- moloch	
	- サーバにおいて目的外のプロトコルの通信が発生
		- sof-elk
			- サブネットマスクを用いて検索
				- src_ip:[172.16.0.0 TO 172.16.255.255]
				- -src_ip:[172.16.0.0 TO 172.16.255.255]
		- molch
- IDSやFWのアラート(hight severity)の発見
	- firewall
		- signature summary
			cat messages | awk '{print $4,$5,$6,$7,$8,$9}' | sort | uniq -c | sort -nr | head -n 10
		- c2
			- grep C2 messages
			- grep C2 messages | awk '{print $9,$14}' | sort | uniq -c | sort -nr #dst
			- grep C2 messages | awk '{print $9,$13}' | sort | uniq -c | sort -nr #src
			- grep C2 messages | awk '{print $9,$13}' | sort | awk -F "\." '{print $1"."$2"."$3}' | uniq -c | sort -nr #src_net
	- zeek
		- signature summary
			- zcat signatures*  | bro-cut sig_id | sort | uniq -c  |sort -nr
		- c2
			- zcat signatures* | bro-cut sig_id src_addr | grep | sort | uniq -c | sort -nr
			- zcat signatures* | bro-cut sig_id dst_addr | grep | sort | uniq -c | sort -nr

- 証言


- 前後ログの確認
	- ログ
		- sof-elk
	- pcap
		- moloch
	- 必要であればeditpcapで特定時間内のpcapを作成
		- editcap -A '2013-08-29 15:12:30' hogein.pcap hogeout.pcap

2次調査(仮説：何がおきたか),1次調査に示した項目が２次調査に回るケースあり
	- c2通信の検査
		- pcap->logの作成
			- tshark -n -C no_desegment_tcp -r 10_3_59_127.pcap  -T fields -e frame.time  -e http.request.method -e http.host -e http.request.uri  -e http.user_agent  'http.request and ip.src == 10.3.59.127'  > useragent.txt
		- user-agentの異常
			- tshark
				- cat useragent.txt  | awk -F "\t" '{print $7}' | sort | uniq -c | sort -rn
			- squid
				- grep ip_hoge access.log | awk -F "\t" '{print $hoge}' | sort | uniq -c | sort -rn
		- POST
			- tshark
				-  grep "POST" useragent.txt  | awk -F "\t" '{print $5,$7}' | sort | uniq -c | sort -nr
		- DGAの通信
			- ドメイン名(ホスト名)を表示してヒューリスティック
		- 不審なポートへの通信
		- fastflux
			 - wireshark
		- 規則的な通信間隔
			- 時間を表示してヒューリスティック
		- 不審なtls
			- ja.py
				- ja3.py -j hoge.pcap  | jq -c '.[]["ja3_digest"]' | sort | uniq -c | sort -nr
				- grep "1d095e68489d3c535297cd8dffb06cb9" /usr/local/for572/lib/ja3fingerprint.json  | jq .desc
				- 一括
				- for ja3fp in $(ja3.py -j stark-20120403-full-ssl.pcap  | jq -c '.[]["ja3_digest"]' | sort | uniq); do echo $ja3fp ;grep $ja3fp /usr/local/for572/lib/ja3fingerprint.json | jq .desc; done  
	- IPアドレスに対する直接アクセス
	- マルウェアダウンロードの検査
		- 外部Webサーバからのダウンロード(Http・https通信で大きめの受信)
			- sof-elk
				- c2のIPアドレスとpassive DNSのログからダウンロードURLを特定
			- サイズが大きいリクエストを表示
				- tshark
					- tshark -n -C no_desegment_tcp -T fields -e frame.len -e fram.time  -e ip.src -e http.request.method -e http.request.uri | uniq -c | sort -nr | head -n 10 
		- FTP経由でファイルのダウンロード
			- ngrep
				- ngrep -q -I hogeftp.pcap -W single 'RETR' 'port 21'
		- SMB経由でファイルのダウンロード
		- メールのでファイルのダウンロード
		- ファイル形式の確認
	- ボットによる挙動の検査
		- 規則的な通信間隔(google検索)
			- Wireshark
				- http.request and http.host contains google
	- 第三者による不正アクセス・操作
		- 不正アクセス試行(webサーバ)
			 - weblog
				- メソッド，URIユニーク数でソート
				- cat utc_ssl_access.log | grep attemp_ip | awk '{print  $6,$7}' | sort |  uniq -c |  sort -nr	
				- レスポンスサイズでsort
				- cat utc_ssl_request.log | grep 93.114.46.11 | sort -k 9 -nr

		- RDP，SSH，TELNET通信
			 - netflow
				- 送信元送信先の特定
				- nfdump -R ./victim-gw/var/log/netflow/localhost/2013/08/  -N -q  -o 'fmt:%sa %da' 'port 5900 and  host 172.16.62.42' | sort | uniq -c 
				- 開始，終了時刻の特定
				-  nfdump -R ./victim-gw/var/log/netflow/localhost/2013/08/  -O tstart -N -o 'fmt:%ts %te %fl %td' 'port 5900 and  host 123.150.207.231' 
				- ログイン成功の確認(vnc)
					- wireshark
						vnc.auth_result == 0
		- FTPでアップロード
		- SMBでアップロード
		- Web通信
			- Google検索
				- Wireshark
					- http.request and http.host contains google
				- tshark
					- tshark -n -r hoge.pcap -T fields -e frame.time -e http.request.uri -Y 'http.request and http.host contains google' | egrep '\&q=.*'
				- squid
					- grep google access.log | egrep '\&q=.*'

			- ダンプサイトへの通信
				- Wireshark
					- http.request.full_uri contains paste
					- http.host  contains "pastesite.com"  and http.request.method == "POST"
				- tshark
					- tshark -n -r hoge.pcap -T fields -e frame.time -e http.request.uri -Y 'http.request and http.host contains google' | egrep '\&q=.*'
					- tshark -n -r hoge.pcap -T fields  -e frame.time -e ip.src -e ip.dst -e frame.len -e http.request.full_uri -Y 'http.host  contains "pastesite.com"  and http.request.method == "POST"
				- squid
					- grep ggole access.log | egrep '\&q=.*'
	- lateral movementの検査
		- RDP(3389)やSMB(445),FTP(20,21)は調べてみる価値あり
		- netflow
			 - nfdump -R ./hoge -O bytes -o 'fmt:%ts %te % td %sap % dap % byt 'net hogehoge and net hogehoge and port 445'
			 - さらに掘り下げp112
		- イベントログ
		- pcap
			- 各種SMBフィルタhackmd day3参照
	- スキャンの検査
		- 単一外部アドレスから内部サーバIPに対して異なるポートで大量通信
	- dos攻撃の検査
		- 複数外部IPアドレスから内部サーバIPへの大量通信
		- DNS amplification(短時間でのDNS応答の複数受信)
		- 外部IPアドレスに対する大量通信
	- udp first response win
		- DNS応答の重複を探す
			- wireshark
				- dns.a == hogeip

3次調査(仮説：原因)，2次調査に示した項目が3次調査に回るケースあり
	- 関連事象の特定
		- プロトコルの絞り込み
			- RDPやSMBは調べてみる価値あり
		- IPアドレスの絞り込み
		- ポートの絞り込み
		- 日程の絞り込み

4次調査(仮説判定)
-  ファイルの悪性判定
	- ファイルの抽出
		- Wireshark
			 - file->export
			 - フィールド->右クリック->export
		- NetworkMiner
		- tcpflow
			- tcpflow -e http -r hogehoge.pcap -o /hoge/hoge
                	- nautilus /hoge/hoge
			- tcpflow -r hogehoge.pcap 
		- Dshell
			- $dshell
             		-  Dshell> decode -d ftp --ftp_dump hogehoge.pcap
             		-  Dshell> decode -d dns hogehoge.pcap
			- moloch
		- tshark
			- p136参照(smb)
	- 圧縮ファイルのパスワードの推測
	- 実行履歴
		- sofelk
			- ダウンロードの前後ログからwindowsイベントログを検索
- c2通信と思わしき通信のプロトコルの悪性判定
	- プロトコル違反しているか
	- user-agentの特徴
	- URIの特徴
	- リクエストメソッドの特徴
	- host名の特徴
	- ペイロードの特徴
	- ポート番号の特徴
- ドメインやIPアドレスの悪性判定
5次調査(仮説：影響範囲）
- アーティファクトから考えられる他の影響を推察 

その他utility
- urlデコード
	- cat hoge.txt | uridecode.py > hoge2.txt
- pcapの開始，終了時刻，サイズの確認
	- capinfos -M -csd  hogehoge.pcap
- 時系列化する
- iptablesのログ /var/message
- zeekのログ /opt/bro/logs/
- pcapからnetflowの作成：Dshell> decode -d netflow hogehoge.pcap
- tlsで特定ホスト名のpcapを作成
	- tshark -n -r stark-20120403-full-ssl.pcap -Y 'x509ce.dNSName==iCModus.com or x509sat.teletexString==iCModus.com or x509sat.uTF8String==iCModus.com or x509sat.universalString==iCModus.com or x509sat.IA5String==iCModus.com' -T fields -e tcp.strem
	- tshark -n -r stark-20120403-full-ssl.pcap -Y 'tcp.stream==2717 or tcp.stream==2719 or tcp.stream==2718' -w /cases/for572/lab-5.1/certfiles.pcap
- certificateの抽出
	- 上記pcapのフィールドからcertficateをexport
	- 人間が読める形に変換
	- openssl x509 -in icmodus.com.cer -noout -text -inform DER
- byte2tebibyte
	- numfmt --to-iec-i --suffix=B hoge

- passivednsのログ作成
	- passivedns -r input.pcap -l pdnslog.txt -L nxdomain.txt
- 複数のpcapファイルから一括でフィルタリングしたpcap
	- for infile in eth1_2013-08-29_07* ; do     tcpdump -n -r $infile -w /cases/for572/lab-5.3/vnc.${infile} 'tcp and port 5900'; done
- pcapの統合
	-  mergecap -w vnc.eth1_combined.pcap vnc.eth1_2013-08-29_07*
- nfdumpで特定時間の指定
	- -O tstart -t '2013/08/29.15:11:14-2013/08/29.15:22:01'
- wireshakrでprivatekeyを用いてtlsトラフィックを復号
	- 

